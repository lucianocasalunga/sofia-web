<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Version: 2025-11-16 12:15 - FIX: Ícone Sofia no topo (não na lateral) para aproveitar espaço -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">
    <!-- iOS: Prevenir zoom e comportamento do teclado -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sofia - Chat</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon-192.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f7f8;
            --bg-chat: #ffffff;
            --text-primary: #0d0d0d;
            --text-secondary: #676767;
            --border-light: #e8e8e8;
            --user-bubble: #d1f4cc;
            --sofia-bubble: #f0f0f0;
            --user-text: #0d0d0d;
            --sofia-text: #0d0d0d;
            --accent: #10a37f;
            --accent-hover: #0d8f6f;
            --shadow: rgba(0,0,0,0.05);
            --sidebar-bg: #ffffff;
            --input-bg: #ffffff;
            --icon-color: #8e8e8e;
            --hover-bg: #f4f4f4;
        }

        body.dark-theme {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-chat: #1a1a1a;
            --text-primary: #ececec;
            --text-secondary: #b4b4b4;
            --border-light: #3a3a3a;
            --user-bubble: #2b5329;
            --sofia-bubble: #2f2f2f;
            --user-text: #e8f5e6;
            --sofia-text: #ececec;
            --accent: #10a37f;
            --accent-hover: #0d8f6f;
            --shadow: rgba(0,0,0,0.3);
            --sidebar-bg: #212121;
            --input-bg: #2f2f2f;
            --icon-color: #b4b4b4;
            --hover-bg: #3a3a3a;
        }

        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2a2a2a;
                --bg-chat: #1a1a1a;
                --text-primary: #ececec;
                --text-secondary: #b4b4b4;
                --border-light: #3a3a3a;
                --user-bubble: #2b5329;
                --sofia-bubble: #2f2f2f;
                --user-text: #e8f5e6;
                --sofia-text: #ececec;
                --accent: #10a37f;
                --accent-hover: #0d8f6f;
                --shadow: rgba(0,0,0,0.3);
                --sidebar-bg: #212121;
                --input-bg: #2f2f2f;
                --icon-color: #b4b4b4;
                --hover-bg: #3a3a3a;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* MOBILE-FIRST: Não usar height fixa ou overflow hidden */
        }

        /* Layout Mobile-First */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
        }

        /* Header */
        .header {
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-light);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 56px;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            padding: 0;
        }

        .menu-btn:active {
            background: var(--hover-bg);
        }

        .menu-btn svg {
            width: 22px;
            height: 22px;
        }

        .chat-title-text {
            font-size: 15px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            gap: 8px; /* Aumentado de 4px para 8px */
        }

        .icon-btn {
            width: 44px; /* Aumentado de 36px */
            height: 44px; /* Aumentado de 36px */
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--icon-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .icon-btn:active {
            background: var(--hover-bg);
            transform: scale(0.95);
        }

        .icon-btn svg {
            width: 22px; /* Aumentado de 20px */
            height: 22px;
        }

        .icon-btn-small {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .icon-btn-small:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        /* Chat Area - MOBILE-FIRST */
        .chat-container {
            flex: 1 1 auto;
            padding: 16px;
            /* Padding extra para compensar o input fixo na parte inferior */
            padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
            /* MOBILE: Scroll natural do body, não overflow interno */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .messages {
            max-width: 768px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 90px;
        }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            margin: 0 auto 16px;
            overflow: hidden;
        }

        .welcome-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .welcome h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .welcome p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: var(--user-bubble);
            color: var(--user-text);
        }

        .message.sofia .message-avatar {
            background: linear-gradient(135deg, #10a37f, #00d9ff);
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            word-wrap: break-word;
            position: relative;
        }

        /* USUÁRIO: Mantém formato de balão */
        .message.user .message-bubble {
            background: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 4px;
        }

        /* SOFIA: Largura total, sem balão (estilo Claude) - ÍCONE NO TOPO */
        .message.sofia {
            width: 100%;
            flex-direction: column; /* Ícone em cima, texto embaixo */
            gap: 8px; /* Espaço entre ícone e texto */
            align-items: flex-start; /* Alinhar ícone à esquerda */
        }

        .message.sofia .message-bubble {
            max-width: 100%;
            width: 100%;
            background: transparent;
            color: var(--sofia-text);
            border-radius: 0;
            padding: 12px 0; /* Apenas padding vertical, sem lateral (usar espaço total) */
            text-align: left;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }

        /* Input Area - ÚNICO E SEMPRE VISÍVEL (estilo Claude/ChatGPT)
         * NOTA: PWAs não podem usar inputAccessoryView (apenas apps nativos iOS).
         * Este input é fixo no bottom e sobe quando o teclado mobile abre.
         * Z-index: 1000 - Fica ABAIXO da sidebar (1100) quando ela está aberta.
         */
        .input-area {
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000; /* Abaixo da sidebar (1100) para não cobrir botão Sair */
            /* Mobile: Garantir que suba com o teclado */
            will-change: transform;
            transition: transform 0.2s ease-out;
            /* iOS: Prevenir zoom quando focar input */
            -webkit-text-size-adjust: 100%;
            /* Hardware acceleration para melhor performance */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            /* Smooth scrolling */
            -webkit-overflow-scrolling: touch;
            /* DuckDuckGo/Mobile: Prevenir problemas de viewport */
            contain: layout style paint;
        }

        /* iOS: Esconder inputs/toolbars extras do teclado */
        input[type="text"]:not(.message-input):not(.modal-input),
        input[type="search"]:not(.message-input) {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* iOS: Remover toolbar de formatação do teclado */
        .message-input::-webkit-input-placeholder { color: var(--text-secondary); }
        .message-input::-moz-placeholder { color: var(--text-secondary); }
        .message-input:-ms-input-placeholder { color: var(--text-secondary); }

        /* iOS: Esconder accessory bar (barra de ferramentas acima do teclado) */
        input, textarea, select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            padding: 6px 6px 6px 16px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px; /* iOS: Evitar zoom automático (mínimo 16px) */
            font-family: inherit;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 22px;
            line-height: 22px;
            padding: 6px 0;
            /* iOS: Remove estilos nativos */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* iOS: Prevenir zoom */
            touch-action: manipulation;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .input-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .attach-btn, .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .attach-btn {
            background: transparent;
            color: var(--icon-color);
        }

        .attach-btn:active {
            background: var(--hover-bg);
            transform: scale(0.95);
        }

        .send-btn {
            background: var(--accent);
            color: white;
        }

        .send-btn:active:not(:disabled) {
            background: var(--accent-hover);
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-light);
            z-index: 200;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.open {
            left: 0;
            z-index: 1100; /* Acima do input para não cobrir botão Sair */
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1099; /* Entre input (1000) e sidebar (1100) quando aberta */
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .sidebar-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            /* Mobile: Padding para não ser coberto pelo input quando sidebar aberta */
            padding-bottom: 80px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            text-align: left;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .sidebar-btn:active {
            background: var(--hover-bg);
        }

        .sidebar-btn.active {
            background: var(--accent);
            color: white;
        }

        .sidebar-section {
            margin-top: 20px;
            margin-bottom: 8px;
            padding: 0 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .chat-item:active {
            background: var(--hover-bg);
        }

        .chat-item.active {
            background: rgba(16, 163, 127, 0.25);
            color: var(--text);
        }

        .chat-item-name {
            flex: 1;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-item-menu {
            opacity: 1;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 18px;
            line-height: 1;
            min-width: 32px;
            text-align: center;
        }

        .chat-item-menu:active {
            background: rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) {
            .chat-item-menu {
                opacity: 0;
            }

            .chat-item:hover .chat-item-menu {
                opacity: 1;
            }
        }

        /* Project Items */
        .project-item {
            margin-bottom: 4px;
        }

        .project-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            gap: 8px;
        }

        .project-header:hover {
            background: var(--hover-bg);
        }

        .project-icon {
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .project-item.collapsed .project-icon {
            transform: rotate(-90deg);
        }

        .project-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-menu {
            opacity: 1;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            min-width: 24px;
            text-align: center;
        }

        .project-menu:active {
            background: rgba(0,0,0,0.1);
        }

        .project-chats {
            padding-left: 20px;
            display: none;
        }

        .project-item:not(.collapsed) .project-chats {
            display: block;
        }

        .sidebar-footer {
            padding: 16px;
            /* Mobile: Padding extra para não ser coberto pelo input */
            padding-bottom: max(90px, calc(90px + env(safe-area-inset-bottom)));
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
            background: var(--sidebar-bg);
            /* GARANTIR QUE APAREÇA NO MOBILE */
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* FORÇAR VISIBILIDADE - sempre no final da sidebar */
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .user-profile-btn {
            width: 100%;
            padding: 12px;
            border: none;
            background: var(--hover-bg);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .user-profile-btn:active {
            background: var(--border-light);
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #00d9ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user-info-small {
            flex: 1;
            min-width: 0;
        }

        .user-name-small {
            font-size: 14px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-plan-small {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Modal Moderno */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
            pointer-events: none; /* Overlay não bloqueia cliques */
        }

        .modal-overlay.active {
            display: flex;
            pointer-events: auto; /* Permite cliques quando modal está ativo */
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            pointer-events: auto; /* Modal recebe cliques */
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .modal-input:focus {
            border-color: var(--accent);
        }

        .modal-actions {
            padding: 16px 20px 20px;
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-secondary {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .modal-btn-secondary:active {
            background: var(--border-light);
        }

        .modal-btn-primary {
            background: var(--accent);
            color: white;
        }

        .modal-btn-primary:active {
            background: var(--accent-hover);
            transform: scale(0.98);
        }

        .modal-btn-danger {
            background: #ef4444;
            color: white;
            font-weight: 600;
        }

        .modal-btn-danger:active {
            background: #dc2626;
            transform: scale(0.98);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--sidebar-bg);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999 !important;
            min-width: 160px;
            padding: 4px 0;
            pointer-events: auto !important;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--hover-bg);
        }

        .context-menu-item.delete {
            color: #ef4444;
        }

        .context-menu-item.delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .context-menu-item svg {
            flex-shrink: 0;
        }

        /* Mobile Optimizations */
        @media (max-width: 767px) {
            html {
                /* Scroll suave no HTML */
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }

            .header {
                /* CRÍTICO: Header fixo no topo do mobile */
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .messages {
                /* Mais padding bottom no mobile */
                padding-bottom: 100px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
                height: 100vh;
                overflow: hidden;
            }

            .chat-container {
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0;
            }

            .sidebar {
                position: static;
                left: 0;
                width: 280px;
                max-width: none;
                border-right: 1px solid var(--border-light);
            }

            .sidebar-overlay {
                display: none !important;
            }

            .menu-btn {
                display: none;
            }

            .header-left {
                padding-left: 8px;
            }

            /* Desktop: Apenas usuário tem balão limitado */
            .message.user .message-bubble {
                max-width: 65%;
            }

            /* Sofia permanece largura total no desktop também */
            .message.sofia .message-bubble {
                max-width: 100%;
                width: 100%;
            }

            /* Input área apenas na coluna central, não sobrepondo sidebar */
            .input-area {
                left: 280px; /* Largura da sidebar desktop */
            }

            /* Desktop: Remover padding extra do footer (não precisa) */
            .sidebar-footer {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            /* Desktop: Remover padding extra do content */
            .sidebar-content {
                padding-bottom: 8px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Safe Area Insets */
        @supports (padding: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
        }

        /* Model Selector Dropdown */
        .model-selector {
            position: relative;
            display: inline-block;
        }

        .model-selector-btn {
            padding: 8px 12px;
            background: var(--hover-bg);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .model-selector-btn:hover {
            background: var(--border-light);
        }

        .model-selector-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            background: var(--sidebar-bg);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }

        .model-selector-dropdown.active {
            display: block;
        }

        .model-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-light);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: var(--hover-bg);
        }

        .model-option.selected {
            background: var(--accent);
            color: white;
        }

        .model-option-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .model-option-desc {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Recharge Modal */
        .recharge-packages {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        .package-card {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .package-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .package-card.popular {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.05), rgba(0, 217, 255, 0.05));
        }

        .package-card.popular::before {
            content: 'POPULAR';
            position: absolute;
            top: -10px;
            right: 16px;
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
        }

        .package-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .package-tokens {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .package-price {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .qr-container {
            text-align: center;
            padding: 20px;
        }

        .qr-container img {
            max-width: 300px;
            width: 100%;
            height: auto;
        }

        /* Logout btn - SEMPRE VISÍVEL */
        .logout-btn {
            width: 100%;
            padding: 12px;
            border: none;
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .logout-btn:active {
            background: #ef4444;
            color: white;
        }

        .logout-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* ===== INDICADOR DE CUSTO ESTIMADO ===== */
        .cost-estimator {
            max-width: 768px;
            margin: 0 auto;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cost-value {
            font-weight: 600;
            color: var(--accent);
        }

        /* ===== BOTÃO HISTÓRICO NA SIDEBAR ===== */
        .history-btn {
            width: 100%;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .history-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ===== MODAL HISTÓRICO ===== */
        .transaction-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .transaction-modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .transaction-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .transaction-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .transaction-modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .transaction-modal-close:hover {
            background: var(--bg-secondary);
        }

        .transaction-modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .transaction-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .transaction-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-type {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .transaction-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
        }

        .transaction-amount.positive {
            color: #10b981;
        }

        .transaction-amount.negative {
            color: #ef4444;
        }

        .transaction-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* ===== MARKDOWN RENDERING STYLES ===== */
        .message-bubble pre {
            position: relative;
            background: var(--code-bg);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
        }

        .message-bubble code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .message-bubble pre code {
            display: block;
            padding: 0;
            background: none;
            border: none;
        }

        .message-bubble :not(pre) > code {
            background: var(--code-inline-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .copy-button:hover {
            opacity: 1;
        }

        .copy-button.copied {
            background: #10a37f;
        }

        :root {
            --code-bg: #f6f8fa;
            --code-inline-bg: #eff1f3;
        }

        [data-theme="dark"] {
            --code-bg: #f6f8fa;
            --code-inline-bg: #eff1f3;
        }

        /* Force code blocks to always have dark text on light background */
        [data-theme="dark"] .message-bubble pre {
            background: #f6f8fa !important;
        }

        [data-theme="dark"] .message-bubble pre code,
        [data-theme="dark"] .message-bubble pre code * {
            color: #24292e !important;
            background: transparent !important;
        }

        [data-theme="dark"] .hljs {
            background: #f6f8fa !important;
            color: #24292e !important;
        }

        [data-theme="dark"] .hljs-comment,
        [data-theme="dark"] .hljs-quote {
            color: #6a737d !important;
        }

        [data-theme="dark"] .hljs-keyword,
        [data-theme="dark"] .hljs-selector-tag,
        [data-theme="dark"] .hljs-subst {
            color: #d73a49 !important;
        }

        [data-theme="dark"] .hljs-number,
        [data-theme="dark"] .hljs-literal,
        [data-theme="dark"] .hljs-variable,
        [data-theme="dark"] .hljs-template-variable,
        [data-theme="dark"] .hljs-tag .hljs-attr {
            color: #005cc5 !important;
        }

        [data-theme="dark"] .hljs-string,
        [data-theme="dark"] .hljs-doctag {
            color: #032f62 !important;
        }

        [data-theme="dark"] .hljs-title,
        [data-theme="dark"] .hljs-section,
        [data-theme="dark"] .hljs-selector-id {
            color: #6f42c1 !important;
        }

        [data-theme="dark"] .hljs-type,
        [data-theme="dark"] .hljs-class .hljs-title {
            color: #005cc5 !important;
        }

        [data-theme="dark"] .hljs-tag,
        [data-theme="dark"] .hljs-name,
        [data-theme="dark"] .hljs-attribute {
            color: #22863a !important;
        }

        [data-theme="dark"] .hljs-regexp,
        [data-theme="dark"] .hljs-link {
            color: #032f62 !important;
        }

        [data-theme="dark"] .hljs-symbol,
        [data-theme="dark"] .hljs-bullet {
            color: #e36209 !important;
        }

        [data-theme="dark"] .hljs-built_in,
        [data-theme="dark"] .hljs-builtin-name {
            color: #005cc5 !important;
        }

        [data-theme="dark"] .hljs-meta {
            color: #005cc5 !important;
        }

        [data-theme="dark"] .hljs-deletion {
            background: #ffeef0 !important;
        }

        [data-theme="dark"] .hljs-addition {
            background: #f0fff4 !important;
        }

        [data-theme="dark"] .hljs-emphasis {
            font-style: italic !important;
        }

        [data-theme="dark"] .hljs-strong {
            font-weight: bold !important;
        }

        .message-bubble ul, .message-bubble ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-bubble li {
            margin: 4px 0;
        }

        .message-bubble p {
            margin: 8px 0;
        }

        .message-bubble h3 {
            margin: 12px 0 8px 0;
            font-size: 1.1em;
        }

        .message-bubble strong {
            font-weight: 600;
        }
    </style>

    <!-- Markdown rendering libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/html.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css" id="hljs-light">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css" id="hljs-dark" disabled>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="/static/logo-sofia.png" alt="Sofia">
                </div>
                <div class="sidebar-info">
                    <h3>Sofia</h3>
                    <p>IA Descentralizada</p>
                </div>
                <!-- Token Counter -->
                <div class="token-counter" onclick="openRechargeModal()" style="margin-top: 8px; padding: 8px 12px; background: var(--hover-bg); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='var(--border-color)'" onmouseout="this.style.background='var(--hover-bg)'" title="Clique para recarregar">
                    <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">⚡ Tokens</div>
                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="sidebar-tokens">-</div>
                </div>
            </div>

            <div class="sidebar-content">
                <button class="sidebar-btn" onclick="createNewChat()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Nova Conversa
                </button>

                <button class="sidebar-btn" onclick="window.location.href='/pricing'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Planos e Pagamentos
                </button>

                <div class="sidebar-section" style="display: flex; align-items: center; justify-content: space-between;">
                    <span>Projetos</span>
                    <button class="icon-btn-small" onclick="openCreateProjectModal()" title="Criar projeto">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
                <div id="projects-list"></div>

                <div class="sidebar-section">Conversas Recentes</div>
                <div id="recent-chats"></div>
            </div>

            <!-- Botão Histórico -->
            <button class="history-btn" onclick="openTransactionHistory()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Histórico de Tokens
            </button>

            <div class="sidebar-footer">
                <div class="user-profile-btn" onclick="openProfile()">
                    <div class="user-avatar-small" id="user-avatar">U</div>
                    <div class="user-info-small">
                        <div class="user-name-small" id="user-name">Usuário</div>
                        <div class="user-plan-small" id="user-plan">free</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Sair
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="menu-btn" onclick="toggleSidebar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="chat-title-text" id="chat-title">Nova Conversa</div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleTheme()" title="Alternar tema" id="theme-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                    <div class="model-selector">
                        <button class="model-selector-btn" onclick="toggleModelDropdown()" id="model-selector-btn">
                            <span id="current-model-text">Sofia 5.0</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="model-selector-dropdown" id="model-dropdown">
                            <div class="model-option" onclick="selectModel('gpt-4o-mini')" data-model="gpt-4o-mini">
                                <div class="model-option-title">⚡ Sofia 4.0 (Mini)</div>
                                <div class="model-option-desc">Rápida e econômica</div>
                            </div>
                            <div class="model-option selected" onclick="selectModel('gpt-5')" data-model="gpt-5">
                                <div class="model-option-title">💎 Sofia 5.0</div>
                                <div class="model-option-desc">Avançada e inteligente</div>
                            </div>
                            <div class="model-option" onclick="selectModel('gpt-5-internet')" data-model="gpt-5-internet">
                                <div class="model-option-title">🌐 Sofia 5.0+</div>
                                <div class="model-option-desc">Com acesso à internet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chat-container">
                <div class="messages" id="messages">
                    <div class="welcome">
                        <div class="welcome-avatar">
                            <img src="/static/logo-sofia.png" alt="Sofia">
                        </div>
                        <h2>Olá! Sou a Sofia</h2>
                        <p>Primeira IA descentralizada do Nostr.<br>Como posso ajudar você hoje?</p>
                    </div>
                </div>
            </div>

            <!-- Input Area - ÚNICO E FUNCIONAL -->
            <div class="input-area">
                <div class="input-wrapper">
                    <button class="attach-btn" onclick="document.getElementById('imageInput').click()" title="Enviar imagem" style="order: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <textarea
                        class="message-input"
                        id="messageInput"
                        placeholder="Mensagem para Sofia..."
                        rows="1"
                        enterkeyhint="send"
                        autocomplete="off"
                        autocorrect="on"
                        autocapitalize="sentences"
                        spellcheck="true"
                        style="order: 1;"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" style="order: 2;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>

                <!-- Indicador de Custo Estimado -->
                <div class="cost-estimator" id="cost-estimator" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <span>Custo estimado: <span class="cost-value" id="estimated-cost">~0</span> tokens</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Modal Renomear -->
    <div class="modal-overlay" id="rename-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Renomear Conversa</div>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="rename-input" placeholder="Novo nome da conversa">
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeRenameModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="saveRename()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Menu Contextual Chat -->
    <div class="context-menu" id="chat-context-menu" style="display: none;">
        <div class="context-menu-item" onclick="openRenameModalFromMenu()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Renomear
        </div>
        <div class="context-menu-item" onclick="showMoveToProjectModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            Mover para Projeto
        </div>
        <div class="context-menu-item delete" onclick="confirmDeleteChat()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Excluir
        </div>
    </div>

    <!-- Modal Criar Projeto -->
    <div class="modal-overlay" id="create-project-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Novo Projeto</div>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="project-name-input" placeholder="Nome do projeto">
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeCreateProjectModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="createProject()">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Exclusão -->
    <div class="modal-overlay" id="confirm-delete-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Excluir Conversa</div>
            </div>
            <div class="modal-body">
                <p style="margin: 0; color: var(--text-secondary);">Deseja excluir essa conversa?</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeConfirmDeleteModal()">Não</button>
                <button class="modal-btn modal-btn-danger" onclick="executeDeleteChat()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Mover para Projeto -->
    <div class="modal-overlay" id="move-project-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Mover para Projeto</div>
            </div>
            <div class="modal-body">
                <div id="project-list-move" style="max-height: 300px; overflow-y: auto;">
                    <!-- Projetos serão inseridos aqui -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeMoveProjectModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Perfil -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Perfil</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Nome</div>
                    <div style="font-size: 15px;" id="profile-name">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Plano</div>
                    <div style="font-size: 15px;" id="profile-plan">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Tokens</div>
                    <div style="font-size: 15px;" id="profile-tokens">-</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeProfile()">Fechar</button>
                <button class="modal-btn modal-btn-primary" onclick="window.location.href='/pricing'">Ver Planos</button>
            </div>
        </div>
    </div>

    <!-- Modal Recarga de Tokens -->
    <div class="modal-overlay" id="recharge-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">⚡ Recarregar Tokens</div>
            </div>
            <div class="modal-body">
                <div class="recharge-packages" id="packages-list" style="display: block;">
                    <div class="package-card" onclick="purchasePackage('starter', 1750000, 3500)">
                        <div class="package-title">Starter</div>
                        <div class="package-tokens">1.75M tokens</div>
                        <div class="package-price">3.500 sats (~R$ 8)</div>
                    </div>
                    <div class="package-card" onclick="purchasePackage('light', 3500000, 7000)">
                        <div class="package-title">Light</div>
                        <div class="package-tokens">3.5M tokens</div>
                        <div class="package-price">7.000 sats (~R$ 16)</div>
                    </div>
                    <div class="package-card popular" onclick="purchasePackage('standard', 8750000, 17500)">
                        <div class="package-title">Standard</div>
                        <div class="package-tokens">8.75M tokens</div>
                        <div class="package-price">17.500 sats (~R$ 40)</div>
                    </div>
                    <div class="package-card" onclick="purchasePackage('pro', 17500000, 35000)">
                        <div class="package-title">Pro</div>
                        <div class="package-tokens">17.5M tokens</div>
                        <div class="package-price">35.000 sats (~R$ 80)</div>
                    </div>
                    <div class="package-card" onclick="purchasePackage('enterprise', 35000000, 70000)">
                        <div class="package-title">Enterprise</div>
                        <div class="package-tokens">35M tokens</div>
                        <div class="package-price">70.000 sats (~R$ 160)</div>
                    </div>
                </div>
                <div class="qr-container" id="qr-container" style="display: none;">
                    <p style="margin-bottom: 16px; font-weight: 600;">Escaneie o QR Code para pagar</p>
                    <img id="qr-code" src="" alt="QR Code">
                    <p style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);">Aguardando pagamento...</p>
                    <div style="margin-top: 8px;">
                        <div style="display: inline-block; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; margin: 0 2px; animation: pulse 1.5s infinite;"></div>
                        <div style="display: inline-block; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; margin: 0 2px; animation: pulse 1.5s infinite 0.2s;"></div>
                        <div style="display: inline-block; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; margin: 0 2px; animation: pulse 1.5s infinite 0.4s;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeRechargeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Histórico de Transações -->
    <div class="transaction-modal" id="transaction-modal">
        <div class="transaction-modal-content">
            <div class="transaction-modal-header">
                <div class="transaction-modal-title">📊 Histórico de Tokens</div>
                <button class="transaction-modal-close" onclick="closeTransactionHistory()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="transaction-modal-body">
                <div class="transaction-list" id="transaction-list">
                    <!-- Transações serão carregadas aqui -->
                    <div class="transaction-empty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        <p>Carregando histórico...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>

    <script>
        // ===== AUTH =====
        function getAuthHeaders() {
            const token = localStorage.getItem('sofia_token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            return headers;
        }

        function checkAuth() {
            const token = localStorage.getItem('sofia_token');
            console.log('[CHAT DEBUG] checkAuth - token exists:', !!token);

            if (token) {
                // Usuário Nostr - buscar dados do localStorage
                const storedUser = localStorage.getItem('sofia_user');
                console.log('[CHAT DEBUG] storedUser raw:', storedUser);

                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    console.log('[CHAT DEBUG] User parsed:', user);
                    console.log('[CHAT DEBUG] User name:', user.name);
                    console.log('[CHAT DEBUG] User picture:', user.picture);

                    const initial = user.name ? user.name[0] : 'N';
                    console.log('[CHAT DEBUG] Calling updateUserUI with:', { initial, name: user.name, picture: user.picture });
                    updateUserUI(initial, user.name || 'Nostr User', user.picture || null);
                } else {
                    console.log('[CHAT DEBUG] No storedUser, usando npub');
                    const npub = localStorage.getItem('sofia_npub');
                    if (npub) {
                        updateUserUI(npub.substring(5, 6).toUpperCase(), npub.substring(0, 16) + '...', null);
                    }
                }
                return true;
            }
            {% if user %}
            // Usuário tradicional (email/senha)
            updateUserUI('{{ user.name[0] }}', '{{ user.name }}', null);
            localStorage.setItem('sofia_user', JSON.stringify({
                id: {{ user.id }},
                name: '{{ user.name }}',
                plan: '{{ user.plan }}'
            }));
            return true;
            {% else %}
            window.location.href = '/login';
            return false;
            {% endif %}
        }

        function updateUserUI(initial, name, picture = null) {
            console.log('[CHAT DEBUG] updateUserUI called:', { initial, name, picture });

            const avatarEl = document.getElementById('user-avatar');
            console.log('[CHAT DEBUG] Avatar element:', avatarEl);

            // Se tiver foto do perfil Nostr, mostrar imagem
            if (picture) {
                console.log('[CHAT DEBUG] Setting avatar image:', picture);
                avatarEl.innerHTML = `<img src="${picture}" alt="${name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                // Senão, mostrar inicial
                console.log('[CHAT DEBUG] Setting avatar initial:', initial);
                avatarEl.textContent = initial.toUpperCase();
            }

            const nameEl = document.getElementById('user-name');
            console.log('[CHAT DEBUG] Name element:', nameEl);
            nameEl.textContent = name;
            console.log('[CHAT DEBUG] updateUserUI completed');
        }

        // ===== STATE =====
        let currentChatId = null;
        let currentModel = localStorage.getItem('selectedModel') || 'gpt-5'; // Sofia 5.0 por padrão
        let chats = [];
        let selectedImage = null;
        let renamingChatId = null;

        // ===== UI =====
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('active');
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = localStorage.getItem('theme') || 'auto';
            let newTheme;

            if (currentTheme === 'auto') {
                newTheme = 'light';
                body.classList.add('light-theme');
                body.classList.remove('dark-theme');
            } else if (currentTheme === 'light') {
                newTheme = 'dark';
                body.classList.add('dark-theme');
                body.classList.remove('light-theme');
            } else {
                newTheme = 'auto';
                body.classList.remove('light-theme', 'dark-theme');
            }

            localStorage.setItem('theme', newTheme);
        }

        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'auto';
            const body = document.body;

            // Get highlight.js theme stylesheets
            const hljsLight = document.getElementById('hljs-light');
            const hljsDark = document.getElementById('hljs-dark');

            if (theme === 'light') {
                body.classList.add('light-theme');
                body.classList.remove('dark-theme');
                // Enable light syntax highlighting
                if (hljsLight) hljsLight.disabled = false;
                if (hljsDark) hljsDark.disabled = true;
            } else if (theme === 'dark') {
                body.classList.add('dark-theme');
                body.classList.remove('light-theme');
                // Enable dark syntax highlighting
                if (hljsLight) hljsLight.disabled = true;
                if (hljsDark) hljsDark.disabled = false;
            } else {
                // Auto mode: follow system preference
                body.classList.remove('light-theme', 'dark-theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (hljsLight) hljsLight.disabled = prefersDark;
                if (hljsDark) hljsDark.disabled = !prefersDark;
            }
        }

        // Auto-resize textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter to send
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ===== MESSAGES =====
        function addMessage(text, sender, skipScroll = false) {
            const messagesContainer = document.getElementById('messages');
            const welcome = messagesContainer.querySelector('.welcome');
            if (welcome) welcome.remove();

            const msg = document.createElement('div');
            msg.className = `message ${sender}`;

            const avatar = sender === 'user'
                ? document.getElementById('user-avatar').textContent
                : '<img src="/static/logo-sofia.png" alt="Sofia">';

            // Para mensagens da Sofia, renderizar markdown
            // Para mensagens do usuário, manter como texto simples
            const content = sender === 'sofia' ? renderMarkdown(text) : escapeHtml(text);

            msg.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-bubble">${content}</div>
            `;
            messagesContainer.appendChild(msg);

            // Adicionar botões de cópia para blocos de código
            if (sender === 'sofia') {
                addCopyButtons(msg);
                // Aplicar syntax highlighting
                msg.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            // Só faz scroll se não foi pedido para pular
            if (!skipScroll) {
                scrollToBottom();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            // Configurar marked.js para parsing seguro
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false, // Não sanitize pois já confiamos na Sofia
                headerIds: false,
                mangle: false
            });

            // Parse markdown para HTML
            return marked.parse(text);
        }

        function addCopyButtons(messageElement) {
            const codeBlocks = messageElement.querySelectorAll('pre');
            codeBlocks.forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = 'Copiar';
                button.onclick = () => copyToClipboard(pre, button);
                pre.appendChild(button);
            });
        }

        async function copyToClipboard(pre, button) {
            const code = pre.querySelector('code');
            const text = code ? code.textContent : pre.textContent;

            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.textContent;
                button.textContent = '✓ Copiado!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Erro ao copiar:', err);
                button.textContent = '✗ Erro';
                setTimeout(() => {
                    button.textContent = 'Copiar';
                }, 2000);
            }
        }

        function addTyping() {
            const msg = document.createElement('div');
            msg.id = 'typing';
            msg.className = 'message sofia';
            msg.innerHTML = `
                <div class="message-avatar">
                    <img src="/static/logo-sofia.png" alt="Sofia">
                </div>
                <div class="message-bubble">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `;
            document.getElementById('messages').appendChild(msg);
            scrollToBottom();
        }

        function removeTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function scrollToBottom() {
            // MOBILE-FIRST: Usar window scroll ao invés de container
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Mobile: scroll da janela
                requestAnimationFrame(() => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            } else {
                // Desktop: scroll do container
                const container = document.getElementById('chat-container');
                if (container) {
                    requestAnimationFrame(() => {
                        container.scrollTop = container.scrollHeight;
                    });
                }
            }
        }

        // ===== SEND MESSAGE =====
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && !selectedImage) return;

            if (!currentChatId) {
                await createNewChat();
                if (!currentChatId) return;
            }

            // Pegar modelo selecionado atual
            const modelToUse = localStorage.getItem('selectedModel') || 'gpt-5';

            addMessage(text || '📷 Imagem', 'user');
            const imageToSend = selectedImage;
            messageInput.value = '';
            messageInput.style.height = 'auto';
            selectedImage = null;
            document.getElementById('sendBtn').disabled = true;
            addTyping();

            try {
                let response;
                if (imageToSend) {
                    const formData = new FormData();
                    formData.append('message', text || 'Analise esta imagem');
                    formData.append('model', modelToUse);
                    formData.append('image', imageToSend);
                    const headers = getAuthHeaders();
                    delete headers['Content-Type'];
                    response = await fetch(`/api/chats/${currentChatId}/message`, {
                        method: 'POST',
                        headers: headers,
                        body: formData,
                        credentials: 'include'
                    });
                } else {
                    response = await fetch(`/api/chats/${currentChatId}/message`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ message: text, model: modelToUse }),
                        credentials: 'include'
                    });
                }

                const data = await response.json();
                removeTyping();

                if (data.content) {
                    addMessage(data.content, 'sofia');
                    await loadChats();
                    await loadBalance();
                } else if (data.error) {
                    addMessage('⚠️ ' + data.error, 'sofia');
                }
            } catch (error) {
                removeTyping();
                addMessage('Erro de conexão: ' + error.message, 'sofia');
            } finally {
                document.getElementById('sendBtn').disabled = false;
                messageInput.focus();
            }
        }

        // ===== IMAGE =====
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas arquivos de imagem');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('Imagem muito grande. Tamanho máximo: 10MB');
                return;
            }
            selectedImage = file;
            event.target.value = '';
        }

        // ===== CHATS =====
        async function createNewChat() {
            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name: 'Nova Conversa' }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentChatId = data.id;
                    document.getElementById('messages').innerHTML = '';
                    document.getElementById('chat-title').textContent = 'Nova Conversa';
                    await loadChats();
                    messageInput.focus();
                    closeSidebar();
                }
            } catch (error) {
                console.error('Erro ao criar chat:', error);
            }
        }

        async function createChatInProject(projectId) {
            console.log('[PROJECT] Criando nova conversa no projeto ID:', projectId);
            try {
                // 1. Criar o chat
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name: 'Nova Conversa' }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Falha ao criar chat');
                }

                const data = await response.json();
                const chatId = data.id;
                console.log('[PROJECT] Chat criado com ID:', chatId);

                // 2. Adicionar chat ao projeto NO SERVIDOR
                console.log('[PROJECT] Adicionando chat ao projeto no servidor...');
                const addResponse = await fetch(`/api/projects/${projectId}/chats`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ chat_id: chatId })
                });

                if (!addResponse.ok) {
                    const error = await addResponse.json();
                    console.error('[PROJECT] Erro ao adicionar ao projeto:', error);
                    throw new Error(error.error || 'Erro ao adicionar ao projeto');
                }

                console.log('[PROJECT] Chat adicionado ao projeto com sucesso!');

                // 3. Recarregar projetos do servidor
                await loadProjects();

                // 4. Abrir o chat criado
                currentChatId = chatId;
                document.getElementById('messages').innerHTML = '';
                document.getElementById('chat-title').textContent = 'Nova Conversa';
                await loadChats();
                messageInput.focus();
                closeSidebar();

                alert('Conversa criada e adicionada ao projeto!');
            } catch (error) {
                console.error('[PROJECT] Erro ao criar chat no projeto:', error);
                alert('Erro ao criar chat no projeto: ' + error.message);
            }
        }

        async function loadChats() {
            try {
                const response = await fetch('/api/chats', {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                chats = await response.json() || [];
                updateRecentChats();
            } catch (error) {
                console.error('Erro ao carregar chats:', error);
            }
        }

        function updateRecentChats() {
            const container = document.getElementById('recent-chats');
            if (!chats.length) {
                container.innerHTML = '<div style="padding: 12px 16px; color: var(--text-secondary); font-size: 13px;">Nenhuma conversa</div>';
                return;
            }

            container.innerHTML = chats.slice(0, 10).map(chat => `
                <div class="chat-item ${currentChatId === chat.id ? 'active' : ''}" onclick="loadChat(${chat.id})">
                    <div class="chat-item-name">${escapeHtml(chat.chat_name || 'Sem nome')}</div>
                    <div class="chat-item-menu" onclick="event.stopPropagation(); showChatContextMenu(event, ${chat.id})">⋯</div>
                </div>
            `).join('');
        }

        async function loadChat(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}`, {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.chat) {
                    currentChatId = chatId;
                    document.getElementById('messages').innerHTML = '';
                    document.getElementById('chat-title').textContent = data.chat.chat_name || 'Conversa';

                    // Adicionar todas as mensagens SEM fazer scroll
                    data.messages.forEach(msg => {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'sofia', true);
                    });

                    // Fazer scroll UMA ÚNICA VEZ no final
                    scrollToBottom();

                    updateRecentChats();
                    messageInput.focus();
                    closeSidebar();
                }
            } catch (error) {
                console.error('Erro ao carregar chat:', error);
            }
        }

        // ===== RENAME MODAL =====
        function openRenameModal(chatId) {
            renamingChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            const currentName = chat ? (chat.chat_name || 'Nova Conversa') : '';
            document.getElementById('rename-input').value = currentName;
            document.getElementById('rename-modal').classList.add('active');
            setTimeout(() => document.getElementById('rename-input').focus(), 300);
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.remove('active');
            renamingChatId = null;
        }

        async function saveRename() {
            const newName = document.getElementById('rename-input').value.trim();
            console.log('saveRename chamado:', { newName, renamingChatId });

            if (!newName) {
                alert('Por favor, digite um nome');
                return;
            }

            if (!renamingChatId) {
                alert('Erro: nenhum chat selecionado');
                return;
            }

            try {
                console.log('Enviando PATCH para:', `/api/chats/${renamingChatId}`);
                const headers = getAuthHeaders();
                console.log('Headers:', headers);
                console.log('Has token:', !!localStorage.getItem('sofia_token'));

                const response = await fetch(`/api/chats/${renamingChatId}`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify({ name: newName }),
                    credentials: 'include'  // SEMPRE incluir cookies para Flask-Login funcionar
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    if (currentChatId === renamingChatId) {
                        document.getElementById('chat-title').textContent = newName;
                    }
                    await loadChats();
                    closeRenameModal();
                } else {
                    const errorText = await response.text();
                    console.error('Erro response:', errorText);
                    alert('Erro ao renomear: ' + response.status);
                }
            } catch (error) {
                console.error('Erro ao renomear:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }

        // ===== CONTEXT MENU =====
        let contextMenuChatId = null;
        let pendingDeleteChatId = null; // Guarda o ID para exclusão
        let pendingMoveChatId = null; // Guarda o ID para mover
        let menuIsOpen = false;

        function showChatContextMenu(event, chatId) {
            event.stopPropagation();
            event.preventDefault();

            const menu = document.getElementById('chat-context-menu');

            // Se já está aberto, fechar
            if (menuIsOpen) {
                menu.style.display = 'none';
                menuIsOpen = false;
                contextMenuChatId = null;
                return;
            }

            // Abrir menu
            contextMenuChatId = chatId;
            menuIsOpen = true;

            // Posicionar menu
            const x = event.clientX || (event.touches && event.touches[0].clientX) || 0;
            const y = event.clientY || (event.touches && event.touches[0].clientY) || 0;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }

        function closeContextMenu() {
            document.getElementById('chat-context-menu').style.display = 'none';
            contextMenuChatId = null;
            menuIsOpen = false;
        }

        function openRenameModalFromMenu() {
            // Salvar chatId ANTES de fechar menu (que apaga contextMenuChatId)
            const chatId = contextMenuChatId;
            closeContextMenu();

            if (chatId) {
                openRenameModal(chatId);
            }
        }

        function confirmDeleteChat() {
            console.log('[DELETE] confirmDeleteChat chamada, contextMenuChatId:', contextMenuChatId);
            // Salvar o ID ANTES de fechar o menu (que apaga contextMenuChatId)
            pendingDeleteChatId = contextMenuChatId;
            console.log('[DELETE] pendingDeleteChatId salvo:', pendingDeleteChatId);
            closeContextMenu();
            document.getElementById('confirm-delete-modal').classList.add('active');
        }

        function closeConfirmDeleteModal() {
            document.getElementById('confirm-delete-modal').classList.remove('active');
            pendingDeleteChatId = null; // Limpar ao cancelar
        }

        async function executeDeleteChat() {
            console.log('[DELETE] executeDeleteChat chamada, pendingDeleteChatId:', pendingDeleteChatId);
            const chatId = pendingDeleteChatId;
            if (!chatId) {
                console.error('[DELETE] pendingDeleteChatId está vazio!');
                return;
            }

            console.log('[DELETE] Fechando modal e chamando deleteChat para ID:', chatId);
            closeConfirmDeleteModal();
            await deleteChat(chatId);
        }

        function showMoveToProjectModal() {
            console.log('[MOVE] showMoveToProjectModal chamada, contextMenuChatId:', contextMenuChatId);
            // Salvar o ID ANTES de fechar o menu
            pendingMoveChatId = contextMenuChatId;
            console.log('[MOVE] pendingMoveChatId salvo:', pendingMoveChatId);
            closeContextMenu();

            if (projects.length === 0) {
                alert('Nenhum projeto disponível. Crie um projeto primeiro.');
                pendingMoveChatId = null;
                return;
            }

            const projectList = document.getElementById('project-list-move');
            projectList.innerHTML = projects.map(p => `
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;"
                     onmouseover="this.style.background='var(--hover-color)'"
                     onmouseout="this.style.background='transparent'"
                     onclick="moveChatToProject(${p.id})">
                    <div style="font-weight: 500;">${p.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        ${p.chatIds.length} conversa(s)
                    </div>
                </div>
            `).join('');

            document.getElementById('move-project-modal').classList.add('active');
        }

        function closeMoveProjectModal() {
            document.getElementById('move-project-modal').classList.remove('active');
            pendingMoveChatId = null; // Limpar ao cancelar
        }

        async function moveChatToProject(projectId) {
            console.log('[MOVE] moveChatToProject chamada, pendingMoveChatId:', pendingMoveChatId, 'projectId:', projectId);
            const chatId = pendingMoveChatId;
            if (!chatId) {
                console.error('[MOVE] pendingMoveChatId está vazio!');
                return;
            }

            console.log('[MOVE] Movendo chat', chatId, 'para projeto', projectId);

            try {
                const response = await fetch(`/api/projects/${projectId}/chats`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ chat_id: chatId })
                });

                console.log('[MOVE] Response status:', response.status);

                if (response.ok) {
                    await loadProjects();
                    closeMoveProjectModal();
                    alert('Conversa movida com sucesso!');
                } else {
                    const error = await response.json();
                    console.error('[MOVE] Error:', error);
                    alert(error.error || 'Erro ao mover conversa');
                }
            } catch (error) {
                console.error('[MOVE] Erro:', error);
                alert('Erro ao mover conversa: ' + error.message);
            }
        }

        async function deleteChat(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });

                if (response.ok) {
                    // Se era o chat atual, criar um novo
                    if (currentChatId === chatId) {
                        await createNewChat();
                    }
                    await loadChats();
                } else {
                    alert('Erro ao excluir conversa: ' + response.status);
                }
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }

        // Fechar menu ao clicar fora
        document.addEventListener('click', (e) => {
            if (!menuIsOpen) return;

            const menu = document.getElementById('chat-context-menu');
            const clickedMenuButton = e.target.closest('.chat-item-menu');

            // Não fechar se clicou no botão de menu ou dentro do menu
            if (clickedMenuButton || menu.contains(e.target)) return;

            closeContextMenu();
        });

        // ===== PROFILE =====
        function openProfile() {
            const userData = JSON.parse(localStorage.getItem('sofia_user') || '{}');
            document.getElementById('profile-name').textContent = userData.name || 'Não informado';
            document.getElementById('profile-plan').textContent = userData.plan || 'free';
            document.getElementById('profile-tokens').textContent = `${userData.tokens_used || 0} / ${userData.tokens_limit || 0}`;
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        // ===== PROJECTS =====
        let projects = [];

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects', {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    projects = data.projects.map(p => ({
                        id: p.id,
                        name: p.name,
                        chatIds: p.chat_ids || [],
                        collapsed: p.collapsed === 1 || p.collapsed === true
                    }));
                    renderProjects();
                }
            } catch (error) {
                console.error('[PROJECTS] Erro ao carregar projetos:', error);
            }
        }

        function openCreateProjectModal() {
            document.getElementById('project-name-input').value = '';
            document.getElementById('create-project-modal').classList.add('active');
            setTimeout(() => document.getElementById('project-name-input').focus(), 300);
        }

        function closeCreateProjectModal() {
            document.getElementById('create-project-modal').classList.remove('active');
        }

        async function createProject() {
            const name = document.getElementById('project-name-input').value.trim();
            if (!name) {
                alert('Digite um nome para o projeto');
                return;
            }

            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    await loadProjects(); // Recarregar projetos do backend
                    closeCreateProjectModal();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erro ao criar projeto');
                }
            } catch (error) {
                console.error('[PROJECTS] Erro ao criar projeto:', error);
                alert('Erro ao criar projeto');
            }
        }

        async function toggleProject(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PATCH',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ collapsed: true })
                });

                if (response.ok) {
                    // Atualizar localmente primeiro para resposta instantânea
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.collapsed = !project.collapsed;
                        renderProjects();
                    }
                }
            } catch (error) {
                console.error('[PROJECTS] Erro ao alternar projeto:', error);
            }
        }

        function renderProjects() {
            const container = document.getElementById('projects-list');
            if (!projects.length) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = projects.map(project => {
                const projectChats = chats.filter(c => project.chatIds.includes(c.id));
                return `
                    <div class="project-item ${project.collapsed ? 'collapsed' : ''}">
                        <div class="project-header" onclick="toggleProject(${project.id})">
                            <svg class="project-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <div class="project-name">${escapeHtml(project.name)}</div>
                            <button class="icon-btn-small" onclick="event.stopPropagation(); createChatInProject(${project.id})" title="Nova conversa neste projeto" style="margin-left: auto; margin-right: 4px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <div class="project-menu" onclick="event.stopPropagation(); showProjectMenu(event, ${project.id})">⋯</div>
                        </div>
                        <div class="project-chats">
                            ${projectChats.map(chat => `
                                <div class="chat-item ${currentChatId === chat.id ? 'active' : ''}" onclick="loadChat(${chat.id})">
                                    <div class="chat-item-name">${escapeHtml(chat.chat_name || 'Sem nome')}</div>
                                    <div class="chat-item-menu" onclick="event.stopPropagation(); showChatContextMenu(event, ${chat.id})">⋯</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function renameProject(projectId) {
            console.log('[RENAME] Renomeando projeto ID:', projectId);
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.error('[RENAME] Projeto não encontrado:', projectId);
                return;
            }

            console.log('[RENAME] Projeto atual:', project);
            const newName = prompt('Novo nome do projeto:', project.name);
            if (!newName || newName.trim() === '' || newName === project.name) {
                console.log('[RENAME] Renomeação cancelada ou nome igual');
                return;
            }

            console.log('[RENAME] Novo nome:', newName.trim());

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PATCH',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name: newName.trim() })
                });

                console.log('[RENAME] Response status:', response.status);

                if (response.ok) {
                    await loadProjects();
                    alert('Projeto renomeado com sucesso!');
                } else {
                    const error = await response.json();
                    console.error('[RENAME] Error:', error);
                    alert(error.error || 'Erro ao renomear projeto');
                }
            } catch (error) {
                console.error('[PROJECTS] Erro ao renomear projeto:', error);
                alert('Erro ao renomear projeto: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            if (!confirm(`Deseja excluir o projeto "${project.name}"?\n\nAs conversas não serão deletadas, apenas removidas do projeto.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadProjects();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erro ao deletar projeto');
                }
            } catch (error) {
                console.error('[PROJECTS] Erro ao deletar projeto:', error);
                alert('Erro ao deletar projeto');
            }
        }

        function showProjectMenu(event, projectId) {
            event.stopPropagation();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.position = 'fixed';
            menu.style.zIndex = '9999';
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';

            menu.innerHTML = `
                <div class="context-menu-item" onclick="renameProject(${projectId}); this.parentElement.remove()">
                    Renomear
                </div>
                <div class="context-menu-item" onclick="deleteProject(${projectId}); this.parentElement.remove()">
                    Excluir
                </div>
            `;

            document.body.appendChild(menu);

            // Fechar ao clicar fora
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        // ===== BALANCE =====
        async function loadBalance() {
            try {
                const response = await fetch('/api/user/balance', {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateBalance(data.balance);
                }
            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
            }
        }

        function updateBalance(balance) {
            const sidebarTokens = document.getElementById('sidebar-tokens');

            let formatted;
            if (balance >= 1000000) {
                formatted = `${(balance / 1000000).toFixed(1)}M`;
            } else if (balance >= 1000) {
                formatted = `${Math.floor(balance / 1000)}k`;
            } else {
                formatted = String(balance);
            }

            // Atualizar contador na sidebar
            if (sidebarTokens) {
                sidebarTokens.textContent = formatted;
            }
        }

        // ===== MODEL SELECTOR =====
        function toggleModelDropdown() {
            const dropdown = document.getElementById('model-dropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }

        function selectModel(modelId) {
            // Salvar modelo selecionado
            localStorage.setItem('selectedModel', modelId);

            // Atualizar UI
            const options = document.querySelectorAll('.model-option');
            options.forEach(opt => opt.classList.remove('selected'));

            const selected = document.querySelector(`[data-model="${modelId}"]`);
            if (selected) {
                selected.classList.add('selected');

                // Atualizar texto do botão
                const title = selected.querySelector('.model-option-title').textContent;
                document.getElementById('current-model-text').textContent = title;
            }

            // Recalcular custo estimado com novo modelo
            estimateTokenCost();

            // Fechar dropdown
            document.getElementById('model-dropdown').style.display = 'none';
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('model-dropdown');
            const selector = document.querySelector('.model-selector');

            if (dropdown && selector && !selector.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // ===== RECHARGE MODAL =====
        let currentPaymentHash = null;
        let paymentCheckInterval = null;

        function openRechargeModal() {
            const modal = document.getElementById('recharge-modal');
            const packagesList = document.getElementById('packages-list');
            const qrContainer = document.getElementById('qr-container');

            if (modal) {
                modal.style.display = 'flex';
                packagesList.style.display = 'block';
                qrContainer.style.display = 'none';

                // Limpar polling anterior se existir
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                    paymentCheckInterval = null;
                }
            }
        }

        function closeRechargeModal() {
            const modal = document.getElementById('recharge-modal');
            if (modal) {
                modal.style.display = 'none';

                // Limpar polling
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                    paymentCheckInterval = null;
                }
                currentPaymentHash = null;
            }
        }

        // Fechar modal ao clicar no overlay
        const rechargeModal = document.getElementById('recharge-modal');
        if (rechargeModal) {
            rechargeModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRechargeModal();
                }
            });
        }

        async function purchasePackage(packageName, tokens, sats) {
            try {
                const headers = getAuthHeaders();
                if (!headers.Authorization) {
                    showStatus('Por favor, faça login primeiro', 'error');
                    return;
                }

                headers['Content-Type'] = 'application/json';

                const response = await fetch('/api/tokens/purchase', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        package: packageName,
                        tokens: tokens,
                        sats: sats
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao criar invoice');
                }

                const data = await response.json();

                // Mostrar QR code
                document.getElementById('packages-list').style.display = 'none';
                document.getElementById('qr-container').style.display = 'block';
                document.getElementById('qr-code').src = data.qr_code;

                currentPaymentHash = data.payment_hash;

                // Iniciar polling para verificar pagamento
                startPaymentPolling(data.payment_hash, tokens);

            } catch (error) {
                console.error('Error purchasing package:', error);
                showStatus('Erro ao criar pagamento: ' + error.message, 'error');
            }
        }

        function startPaymentPolling(paymentHash, tokens) {
            // Verificar a cada 3 segundos
            paymentCheckInterval = setInterval(async () => {
                try {
                    const headers = getAuthHeaders();
                    const response = await fetch(`/api/tokens/check-payment/${paymentHash}`, {
                        headers,
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (data.paid) {
                            // Pagamento confirmado! Creditar tokens
                            await creditTokens(paymentHash, tokens);

                            // Limpar polling
                            clearInterval(paymentCheckInterval);
                            paymentCheckInterval = null;

                            // Fechar modal
                            closeRechargeModal();

                            // Mostrar mensagem de sucesso
                            showStatus(`✅ Recarga confirmada! ${formatTokens(tokens)} tokens adicionados`, 'success');

                            // Atualizar saldo
                            loadBalance();
                        }
                    }
                } catch (error) {
                    console.error('Error checking payment:', error);
                }
            }, 3000);
        }

        async function creditTokens(paymentHash, tokens) {
            try {
                const headers = getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch('/api/tokens/credit', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        payment_hash: paymentHash,
                        tokens: tokens
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao creditar tokens');
                }

                return await response.json();
            } catch (error) {
                console.error('Error crediting tokens:', error);
                throw error;
            }
        }

        function formatTokens(tokens) {
            if (tokens >= 1000000) {
                return (tokens / 1000000).toFixed(1) + 'M';
            } else if (tokens >= 1000) {
                return Math.round(tokens / 1000) + 'k';
            }
            return tokens.toString();
        }

        // ===== INDICADOR DE CUSTO ESTIMADO =====
        let modelCosts = {};
        let estimatedCost = 0;

        async function loadModelCosts() {
            try {
                const response = await fetch('/api/models');
                if (response.ok) {
                    const data = await response.json();
                    data.models.forEach(model => {
                        modelCosts[model.id] = {
                            input: model.cost_per_1k_input || 0,
                            output: model.cost_per_1k_output || 0
                        };
                    });
                }
            } catch (error) {
                console.error('Error loading model costs:', error);
            }
        }

        function estimateTokenCost() {
            const input = document.getElementById('messageInput');
            if (!input) return;

            const text = input.value;
            if (!text || text.trim().length === 0) {
                document.getElementById('cost-estimator').style.display = 'none';
                return;
            }

            // Estimativa grosseira: 1 token ≈ 4 caracteres
            const estimatedInputTokens = Math.ceil(text.length / 4);
            const selectedModel = localStorage.getItem('selectedModel') || 'gpt-5';

            if (modelCosts[selectedModel]) {
                const costs = modelCosts[selectedModel];
                // Estimar custo (input + estimativa de output ~150 tokens)
                const inputCost = (estimatedInputTokens / 1000) * costs.input;
                const estimatedOutputCost = (150 / 1000) * costs.output;
                estimatedCost = Math.ceil(inputCost + estimatedOutputCost);

                document.getElementById('estimated-cost').textContent = `~${estimatedCost}`;
                document.getElementById('cost-estimator').style.display = 'flex';
            } else {
                document.getElementById('cost-estimator').style.display = 'none';
            }
        }

        // ===== HISTÓRICO DE TRANSAÇÕES =====
        async function openTransactionHistory() {
            const modal = document.getElementById('transaction-modal');
            if (modal) {
                modal.style.display = 'flex';
                await loadTransactionHistory();
            }
        }

        function closeTransactionHistory() {
            const modal = document.getElementById('transaction-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadTransactionHistory() {
            try {
                const headers = getAuthHeaders();
                if (!headers.Authorization) {
                    document.getElementById('transaction-list').innerHTML = `
                        <div class="transaction-empty">
                            <p>Faça login para ver seu histórico</p>
                        </div>
                    `;
                    return;
                }

                const response = await fetch('/api/tokens/transactions?limit=50', {
                    headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar histórico');
                }

                const data = await response.json();
                const transactions = data.transactions;

                if (transactions.length === 0) {
                    document.getElementById('transaction-list').innerHTML = `
                        <div class="transaction-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            <p>Nenhuma transação ainda</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                transactions.forEach(tx => {
                    const isPositive = tx.type === 'purchase' || tx.amount > 0;
                    const amountClass = isPositive ? 'positive' : 'negative';
                    const amountPrefix = isPositive ? '+' : '';

                    const date = new Date(tx.timestamp);
                    const dateStr = date.toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let typeText = '';
                    let detailsText = '';

                    if (tx.type === 'purchase') {
                        typeText = '💰 Recarga';
                        detailsText = `${dateStr}`;
                    } else {
                        typeText = '💬 Uso';
                        detailsText = `${tx.model || 'Sofia'} • ${dateStr}`;
                    }

                    html += `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-type">${typeText}</div>
                                <div class="transaction-details">${detailsText}</div>
                            </div>
                            <div class="transaction-amount ${amountClass}">
                                ${amountPrefix}${formatTokens(Math.abs(tx.amount))}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('transaction-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading transaction history:', error);
                document.getElementById('transaction-list').innerHTML = `
                    <div class="transaction-empty">
                        <p>Erro ao carregar histórico</p>
                    </div>
                `;
            }
        }

        // ===== NOSTR PROFILE FETCH (ASYNC COM POLLING) =====
        async function fetchNostrProfileAsync() {
            try {
                const storedUser = localStorage.getItem('sofia_user');
                if (!storedUser) return;

                const user = JSON.parse(storedUser);

                // Se tem npub mas nome é genérico, buscar perfil
                if (user.npub && user.name && user.name.startsWith('Nostr User npub')) {
                    console.log('[PROFILE] Disparando busca de perfil Nostr em background...');

                    // Disparar busca (retorna imediatamente)
                    const response = await fetch('/api/user/fetch-nostr-profile', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });

                    if (response.status === 202) {
                        console.log('[PROFILE] Busca iniciada, aguardando resultado...');

                        // Fazer polling a cada 3 segundos por até 40 segundos
                        let attempts = 0;
                        const maxAttempts = 13; // 13 * 3 = 39 segundos

                        const pollInterval = setInterval(async () => {
                            attempts++;

                            try {
                                // Buscar dados atualizados do usuário
                                const userResponse = await fetch('/api/user', {
                                    headers: getAuthHeaders(),
                                    credentials: 'include'
                                });

                                if (userResponse.ok) {
                                    const userData = await userResponse.json();

                                    // Se nome mudou (não é mais genérico), perfil foi encontrado
                                    if (userData.name && !userData.name.startsWith('Nostr User npub')) {
                                        clearInterval(pollInterval);
                                        console.log('[PROFILE] Perfil encontrado:', userData.name);

                                        // Atualizar localStorage
                                        const updatedUser = {
                                            ...user,
                                            name: userData.name,
                                            picture: userData.picture || ''
                                        };
                                        localStorage.setItem('sofia_user', JSON.stringify(updatedUser));

                                        // Atualizar UI (3 parâmetros separados)
                                        updateUserUI(
                                            userData.name.charAt(0).toUpperCase(),
                                            userData.name,
                                            userData.picture || ''
                                        );
                                    }
                                }

                                // Parar polling após max attempts
                                if (attempts >= maxAttempts) {
                                    clearInterval(pollInterval);
                                    console.log('[PROFILE] Timeout de polling, perfil não encontrado');
                                }
                            } catch (pollError) {
                                console.error('[PROFILE] Erro no polling:', pollError);
                            }
                        }, 3000); // A cada 3 segundos
                    }
                }
            } catch (error) {
                console.error('[PROFILE] Erro ao buscar perfil async:', error);
            }
        }

        // ===== LOGOUT =====
        async function logout() {
            try {
                await fetch('/logout', { method: 'POST', credentials: 'include' });
            } catch (e) {}
            localStorage.clear();
            window.location.href = '/login';
        }

        // ===== MOBILE KEYBOARD FIX (DuckDuckGo/Safari/Chrome) =====
        // Ajusta viewport e input quando teclado mobile abre/fecha
        function handleKeyboardResize() {
            const inputArea = document.querySelector('.input-area');
            const chatContainer = document.querySelector('.chat-container');

            // Detectar se teclado está aberto (viewport height diminui)
            const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            const windowHeight = window.innerHeight;
            const keyboardHeight = windowHeight - viewportHeight;

            if (keyboardHeight > 100) {
                // Teclado aberto - garantir que input fique visível
                inputArea.style.bottom = '0';
                chatContainer.style.paddingBottom = `calc(${keyboardHeight}px + 100px)`;
            } else {
                // Teclado fechado - resetar
                inputArea.style.bottom = '0';
                chatContainer.style.paddingBottom = 'calc(100px + env(safe-area-inset-bottom, 0px))';
            }

            // Scroll para última mensagem ao abrir teclado
            if (keyboardHeight > 100) {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 100);
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', async function() {
            applyTheme();

            // Inicializar seletor de modelo
            const selectedModel = localStorage.getItem('selectedModel') || 'gpt-5';
            const modelOption = document.querySelector(`[data-model="${selectedModel}"]`);
            if (modelOption) {
                // Marcar como selecionado
                document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('selected'));
                modelOption.classList.add('selected');

                // Atualizar texto do botão
                const title = modelOption.querySelector('.model-option-title').textContent;
                document.getElementById('current-model-text').textContent = title;
            }

            if (!checkAuth()) return;
            await loadChats();
            await loadProjects(); // Carrega projetos do backend
            await loadBalance();
            await loadModelCosts(); // Carrega custos dos modelos

            // Buscar perfil Nostr de forma assíncrona (não bloqueia UI)
            fetchNostrProfileAsync();

            // Event listeners para mobile keyboard (DEPOIS do DOM carregar)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', handleKeyboardResize);
                window.visualViewport.addEventListener('scroll', handleKeyboardResize);
            }
            window.addEventListener('resize', handleKeyboardResize);

            // Prevenir zoom no DuckDuckGo quando focar input
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                // Event listener para calcular custo estimado
                messageInput.addEventListener('input', estimateTokenCost);

                messageInput.addEventListener('focus', function(e) {
                    // Scroll suave até o input
                    setTimeout(() => {
                        e.target.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                });

                // Focus no input (evitar auto-zoom no mobile)
                if (window.innerWidth > 768) {
                    messageInput.focus();
                }
            }
        });
    </script>
</body>
</html>
